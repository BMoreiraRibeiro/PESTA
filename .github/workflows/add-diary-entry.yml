name: Adicionar Entrada ao Di√°rio T√©cnico

on:
  issues:
    types: [opened]

permissions:
  contents: write
  issues: write

jobs:
  add-diary-entry:
    # S√≥ executa se a issue tiver o label "di√°rio"
    if: contains(github.event.issue.labels.*.name, 'di√°rio')
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Parse Issue and Add to Diary
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const issue = context.payload.issue;
            const body = issue.body;
            
            // Extrair informa√ß√µes do issue body
            const extractField = (label) => {
              const regex = new RegExp(`### ${label}\\s*([\\s\\S]*?)(?=###|$)`, 'i');
              const match = body.match(regex);
              return match ? match[1].trim() : '';
            };
            
            const title = extractField('üìå T√≠tulo da Entrada');
            const category = extractField('üè∑Ô∏è Categoria');
            const contextField = extractField('üìù Contexto');
            const done = extractField('‚úÖ O Que Foi Feito');
            const decisions = extractField('üéØ Decis√µes Tomadas');
            const results = extractField('üìä Resultados');
            const next = extractField('üöÄ Pr√≥ximos Passos');
            const notes = extractField('üí° Notas/Observa√ß√µes');
            
            // Obter data atual
            const date = new Date().toISOString().split('T')[0];
            
            // Construir entrada em Markdown
            let entry = `## [${date}] - ${title}\n\n`;
            entry += `**Categoria:** ${category}\n\n`;
            
            if (contextField && contextField !== '_No response_') {
              entry += `### Contexto\n${contextField}\n\n`;
            }
            
            if (done && done !== '_No response_') {
              entry += `### O Que Foi Feito\n${done}\n\n`;
            }
            
            if (decisions && decisions !== '_No response_') {
              entry += `### Decis√µes Tomadas\n${decisions}\n\n`;
            }
            
            if (results && results !== '_No response_') {
              entry += `### Resultados\n${results}\n\n`;
            }
            
            if (next && next !== '_No response_') {
              // Converter para checkboxes se n√£o tiver j√°
              const nextLines = next.split('\n').map(line => {
                line = line.trim();
                if (!line) return '';
                if (line.startsWith('- [ ]') || line.startsWith('- [x]')) {
                  return line;
                }
                if (line.startsWith('-')) {
                  return line.replace(/^-\s*/, '- [ ] ');
                }
                return `- [ ] ${line}`;
              }).filter(line => line).join('\n');
              
              entry += `### Pr√≥ximos Passos\n${nextLines}\n\n`;
            }
            
            if (notes && notes !== '_No response_') {
              entry += `### Notas/Observa√ß√µes\n${notes}\n\n`;
            }
            
            entry += `---\n\n`;
            
            // Ler arquivo existente
            const diaryPath = 'docs/technical_diary.md';
            let diaryContent = fs.readFileSync(diaryPath, 'utf8');
            
            // Encontrar onde inserir (ap√≥s o t√≠tulo principal)
            const lines = diaryContent.split('\n');
            let insertIndex = 0;
            
            // Procurar linha ap√≥s o t√≠tulo principal
            for (let i = 0; i < lines.length; i++) {
              if (lines[i].startsWith('# ')) {
                insertIndex = i + 1;
                // Pular linhas vazias ap√≥s o t√≠tulo
                while (insertIndex < lines.length && !lines[insertIndex].trim()) {
                  insertIndex++;
                }
                break;
              }
            }
            
            // Inserir nova entrada
            lines.splice(insertIndex, 0, '', entry);
            
            // Escrever de volta
            fs.writeFileSync(diaryPath, lines.join('\n'));
            
            console.log('Entrada adicionada com sucesso!');

      - name: Commit and Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add docs/technical_diary.md
          git commit -m "docs: adicionar entrada ao di√°rio [$(date +%Y-%m-%d)] [skip ci]"
          git push

      - name: Close Issue and Comment
        uses: actions/github-script@v7
        with:
          script: |
            const date = new Date().toISOString().split('T')[0];
            
            // Comentar na issue
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `‚úÖ **Entrada adicionada com sucesso ao di√°rio t√©cnico!**\n\nüìÖ Data: ${date}\n\nüîó [Ver Di√°rio T√©cnico](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/master/docs/technical_diary.md)\n\nüåê [Ver no Site](https://${context.repo.owner}.github.io/${context.repo.repo}/technical_diary/)`
            });
            
            // Fechar a issue
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              state: 'closed',
              labels: ['di√°rio', 'conclu√≠do']
            });
